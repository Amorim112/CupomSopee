<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cupons do Amorim</title>
  <meta name="description" content="Obtenha o cupom do Mercado Libre Shopping com um clique." />
  <style>
    :root{
      --bg:#0b0d12; --fg:#e9eef5; --card:#141821; --accent:#ffd04d; --muted:#a9b7c6; --danger:#e57373; --ok:#25D366;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Arial,sans-serif}
    .wrap{max-width:880px;margin:36px auto;padding:0 16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    h1{margin:0;font-size:28px}
    .small{color:var(--muted);font-size:13px}
    .card{background:var(--card);border:1px solid #223049;border-radius:16px;padding:18px}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .code{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0e121a;border:1px dashed #334861;
          border-radius:12px;padding:12px 14px;font-size:18px;letter-spacing:.5px}
    .hidden{filter:blur(6px);user-select:none}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
    .btn-primary{background:var(--accent);color:#1a1a1a}
    .btn-copy{background:#2b364a;color:#e9eef5}
    .btn-whats{background:var(--ok);color:#0b0d12}
    .bad{background:#330e0e;border:1px solid #5e1c1c;border-radius:12px;padding:12px;margin-top:10px}
    .hint{color:var(--muted);margin-top:8px}
    a.cta{display:inline-block;text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>üí• Cupom Mercado Libre Shopping</h1>
      <div id="updated" class="small"></div>
    </header>

    <section class="card" id="panel">
      <div class="row" style="justify-content:space-between">
        <div style="min-width:240px;flex:1">
          <div class="small">Cupom:</div>
          <div id="cupom" class="code hidden" aria-live="polite">‚Äî</div>
          <div id="expira" class="small" style="margin-top:6px"></div>
          <div id="desc" class="small" style="margin-top:4px"></div>
        </div>

        <div style="display:flex;flex-direction:column;gap:8px">
          <button id="btn-obter" class="btn btn-primary">üëâ Obter cupom</button>
          <button id="btn-copiar" class="btn btn-copy" style="display:none">üìã Copiar c√≥digo</button>
          <a id="btn-whats" class="btn btn-whats cta" style="display:none" target="_blank" rel="noopener">üí¨ Enviar no WhatsApp</a>
        </div>
      </div>

      <div id="alert" class="bad" style="display:none"></div>
      <div class="hint">O cupom fica oculto at√© voc√™ clicar em ‚ÄúObter cupom‚Äù. Ao clicar, o c√≥digo aparece e o link abre em nova aba.</div>
    </section>
  </div>

  <script>
    let DATA = { cupom: "", link: "" };

    async function carregar() {
      try {
        const url = `./coupons.json?ver=${Date.now()}`; // evita cache
        const r = await fetch(url, { cache: "no-store" });
        if (!r.ok) throw new Error("Falha ao ler coupons.json");
        const data = await r.json();
        DATA = data;

        // Preenche campos
        const cupomEl = document.getElementById('cupom');
        cupomEl.textContent = data.cupom || '‚Äî';
        document.getElementById('desc').textContent   = data.descricao ? `‚ÑπÔ∏è ${data.descricao}` : '';
        document.getElementById('expira').textContent = data.expira_em ? `‚è≥ V√°lido at√©: ${data.expira_em}` : '';
        document.getElementById('updated').textContent= data.atualizado_em ? `Atualizado: ${new Date(data.atualizado_em).toLocaleString('pt-BR')}` : '';

        // Bot√£o WhatsApp com mensagem pronta (s√≥ mostra depois de revelar)
        const btnWhats = document.getElementById('btn-whats');
        const msg = encodeURIComponent(`üî• Cupom ${data.cupom} ‚Äî Use aqui: ${data.link}`);
        btnWhats.href = `https://wa.me/?text=${msg}`;
      } catch (e) {
        const alert = document.getElementById('alert');
        alert.style.display = 'block';
        alert.innerHTML = `<b>N√£o foi poss√≠vel carregar o cupom.</b><br><small>${e.message}</small>`;
        console.error(e);
      }
    }

    // Clique em Obter cupom: revela e abre o link
    async function onObter() {
      try {
        if (!DATA || !DATA.link) throw new Error("Link do cupom indispon√≠vel.");
        // Revela o c√≥digo (remove blur)
        const cupomEl = document.getElementById('cupom');
        cupomEl.classList.remove('hidden');

        // Mostra bot√µes de copiar e Whats
        document.getElementById('btn-copiar').style.display = 'inline-block';
        document.getElementById('btn-whats').style.display  = 'inline-block';

        // Abre o link em nova aba (respeitando pop-up blockers)
        const newTab = window.open(DATA.link, '_blank', 'noopener');
        if (!newTab) {
          // Se o navegador bloqueou pop-up, mostra aviso com link
          const alert = document.getElementById('alert');
          alert.style.display = 'block';
          alert.innerHTML = `üîó Seu navegador bloqueou a abertura autom√°tica. <a href="${DATA.link}" target="_blank" rel="noopener" style="color:#ffd04d">Clique aqui para abrir o link</a>.`;
        }
      } catch (e) {
        const alert = document.getElementById('alert');
        alert.style.display = 'block';
        alert.textContent = e.message;
      }
    }

    // Copiar cupom para √°rea de transfer√™ncia
    async function onCopiar() {
      try {
        if (!DATA.cupom) throw new Error("Nenhum c√≥digo para copiar.");
        await navigator.clipboard.writeText(DATA.cupom);
        const btn = document.getElementById('btn-copiar');
        const old = btn.textContent;
        btn.textContent = "‚úÖ Copiado!";
        setTimeout(() => btn.textContent = old, 1500);
      } catch {
        const alert = document.getElementById('alert');
        alert.style.display = 'block';
        alert.textContent = "N√£o foi poss√≠vel copiar automaticamente. Selecione e copie manualmente.";
      }
    }

    // Eventos
    document.getElementById('btn-obter').addEventListener('click', onObter);
    document.getElementById('btn-copiar').addEventListener('click', onCopiar);

    // Start
    carregar();
  </script>
</body>
</html>
