<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cupom Mercado Livre</title>

  <!-- üî• Anti-cache para o HTML -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <style>
    :root{ --bg:#0b0d12; --fg:#e9eef5; --card:#141821; --accent:#ffd04d; --muted:#a9b7c6; --ok:#25D366 }
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Arial,sans-serif}
    .wrap{max-width:880px;margin:36px auto;padding:0 16px}
    a.back{color:#9ecbff;text-decoration:none}
    .small{color:var(--muted);font-size:13px}
    .card{background:var(--card);border:1px solid #223049;border-radius:16px;padding:18px;margin-top:12px}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between}
    .code{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0e121a;border:1px dashed #334861;
          border-radius:12px;padding:12px 14px;font-size:18px;letter-spacing:.5px;min-width:220px}
    .hidden{filter:blur(6px);user-select:none}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
    .btn-primary{background:var(--accent);color:#1a1a1a}
    .btn-copy{background:#2b364a;color:#e9eef5}
    .btn-whats{background:var(--ok);color:#0b0d12;text-decoration:none;display:inline-block;text-align:center}
    .bad{background:#330e0e;border:1px solid #5e1c1c;border-radius:12px;padding:12px;margin-top:10px}
    .toolbar{display:flex;gap:10px;align-items:center;margin:8px 0 0}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üíõ Cupom Mercado Livre</h1>
    <div class="toolbar">
      <div id="updated" class="small"></div>
      <button id="btn-recarregar" class="btn btn-copy" title="Recarregar dados">üîÑ Atualizar</button>
    </div>

    <section class="card">
      <div class="row">
        <div style="min-width:260px;flex:1">
          <div class="small">Cupom:</div>
          <div id="cupom" class="code hidden" aria-live="polite">‚Äî</div>
          <div id="expira" class="small" style="margin-top:6px"></div>
          <div id="desc" class="small" style="margin-top:4px"></div>
        </div>

        <div style="display:flex;flex-direction:column;gap:8px;min-width:220px">
          <button id="btn-obter" class="btn btn-primary">üëâ Obter cupom</button>
          <button id="btn-copiar" class="btn btn-copy" style="display:none">üìã Copiar c√≥digo</button>
          <a id="btn-whats" class="btn btn-whats" style="display:none" target="_blank" rel="noopener">üí¨ Enviar no WhatsApp</a>
        </div>
      </div>
      <div id="alert" class="bad" style="display:none"></div>
    </section>
  </div>

  <script>
    let DATA = { cupom:"", link:"" };

    const jsonUrl = () => {
      const bust = Date.now().toString(36);
      return `./coupons_ml.json?t=${bust}`;
    };

    async function fetchComRetry(maxTentativas = 3, atrasoMs = 800) {
      let ultimaErro;
      for (let i = 0; i < maxTentativas; i++) {
        try {
          const r = await fetch(jsonUrl(), { cache: "no-store" });
          if (!r.ok) throw new Error(`Erro ${r.status} ao ler coupons_ml.json`);
          return await r.json();
        } catch (e) {
          ultimaErro = e;
          await new Promise(res => setTimeout(res, atrasoMs));
        }
      }
      throw ultimaErro;
    }

    async function carregar() {
      try {
        const data = await fetchComRetry();
        DATA = data;

        document.getElementById('cupom').textContent = data.cupom || '‚Äî';
        document.getElementById('desc').textContent   = data.descricao ? `‚ÑπÔ∏è ${data.descricao}` : '';
        document.getElementById('expira').textContent = data.expira_em ? `‚è≥ V√°lido at√©: ${normalizarData(data.expira_em)}` : '';
        document.getElementById('updated').textContent= data.atualizado_em ? `Atualizado: ${normalizarData(data.atualizado_em, true)}` : '';

        const msg = encodeURIComponent(`üî• Cupom ${data.cupom} ‚Äî Use aqui: ${data.link}`);
        const btnWhats = document.getElementById('btn-whats');
        btnWhats.href = `https://wa.me/?text=${msg}`;
      } catch(e) {
        const alert = document.getElementById('alert');
        alert.style.display='block';
        alert.innerHTML = `<b>N√£o foi poss√≠vel carregar.</b><br><small>${e.message}</small>`;
        console.error(e);
      }
    }

    function normalizarData(valor, mostrarHora = false) {
      const d = new Date(valor);
      return d.toLocaleString('pt-BR', {
        year: 'numeric', month: '2-digit', day: '2-digit',
        ...(mostrarHora ? { hour: '2-digit', minute: '2-digit', second: '2-digit' } : {})
      });
    }

    function onObter(){
      try{
        if(!DATA || !DATA.link) throw new Error("Link do cupom indispon√≠vel.");

        // revela o cupom e bot√µes
        document.getElementById('cupom').classList.remove('hidden');
        document.getElementById('btn-copiar').style.display='inline-block';
        document.getElementById('btn-whats').style.display='inline-block';

        // espera 10 segundos e abre o link
        setTimeout(()=>{
          const newTab = window.open(DATA.link,'_blank','noopener');
          if(!newTab){
            const alert = document.getElementById('alert');
            alert.style.display='block';
            alert.innerHTML = `üîó Pop-up bloqueado. <a href="${DATA.link}" target="_blank" rel="noopener" style="color:#ffd04d">Abra o link</a>.`;
          }
        }, 1500); // 10 segundos

      }catch(e){
        const alert = document.getElementById('alert');
        alert.style.display='block';
        alert.textContent = e.message;
      }
    }

    async function onCopiar(){
      try{
        await navigator.clipboard.writeText(DATA.cupom || '');
        const btn = document.getElementById('btn-copiar'), old=btn.textContent;
        btn.textContent="‚úÖ Copiado!"; setTimeout(()=>btn.textContent=old,1500);
      }catch{ /* ignore */ }
    }

    document.getElementById('btn-recarregar').addEventListener('click', carregar);
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') carregar();
    });

    document.getElementById('btn-obter').addEventListener('click', onObter);
    document.getElementById('btn-copiar').addEventListener('click', onCopiar);
    carregar();
  </script>
</body>
</html>
